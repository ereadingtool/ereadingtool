name: django-tests
on: 
  push:
    branches:
      - 'feature/ci-cd-with-actions'
      - 'feature/cypress'
    paths-ignore:
      - 'README'
      - '.gitignore'
jobs:
  elm-tests:
    runs-on: "ubuntu-latest"
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Setup Elm environment
        run: |
          curl -L -o elm.gz https://github.com/elm/compiler/releases/download/0.19.1/binary-for-linux-64-bit.gz
          gunzip elm.gz
          chmod +x elm
          sudo mv elm /usr/local/bin
          cd web
          npm install elm-test
          ./node_modules/elm-test/bin/elm-test
    
  django-tests:
    runs-on: "ubuntu-latest"
    environment: ereadingtool tests
    env:
      DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
      SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      YANDEX_TRANSLATION_API_KEY: ${{ secrets.YANDEX_TRANSLATION_API_KEY }}
      YANDEX_DEFINITION_API_KEY: ${{ secrets.YANDEX_DEFINITION_API_KEY }}
      TEST_JWT: ${{ secrets.TEST_JWT }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Setup Django environment
        run: |
          pip3 install setuptools
          pip3 install -r requirements.txt
          python3 manage.py test

  cypress-tests:
    runs-on: "ubuntu-latest"
    environment: ereadingtool tests 
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
        # need to setup the backend and frontend here
      - name: Setup Django environment
        run: |
          pip3 install setuptools
          pip3 install -r requirements.txt
          python3 manage.py migrate
          python3 manage.py shell -c "import os; from user.models import ReaderUser; ReaderUser.objects.create_superuser(os.getenv('CYPRESS_ADMIN_USER'), os.getenv('CYPRESS_ADMIN_EMAIL'), os.getenv('CYPRESS_ADMIN_PWD'))"
          python3 manage.py runserver
        run: |
          cd admin_panel
          python3 manage.py migrate
          python3 manage.py runserver 8001
      - name: Setup Elm environment
        run: |
          curl -L -o elm.gz https://github.com/elm/compiler/releases/download/0.19.1/binary-for-linux-64-bit.gz
          gunzip elm.gz
          chmod +x elm
          sudo mv elm /usr/local/bin
          cd web
          npm start
      - name: Cypress run
        uses: cypress-io/github-action@v2
        with:
          # not sure if these are the correct steps
          # these need to be run after everything is setup, with the admin panel stuff first.
          build: npm run
          start: npm start